---
- sudo: yes
  hosts: all
  tasks:
    - name: ensure base packages are installed
      yum: pkg={{ item }} state=installed
      with_items:
        - "bind-utils"
        - "psmisc"
        - "perl-libwww-perl"
        - "lsof"
        - "net-tools"
        - "gcc"
        - "readline-devel"
        - "pcre-devel"
        - "openssl-devel"

    - name: directories
      file: path="{{ item }}" state=directory
      with_items:
        - "/srv/dummy-api"
        - "/srv/dummy-api/www"
        - "/srv/dummy-api/conf"
        - "/var/log/dummy-api"

    - name: "ensure dummy-api user exists"
      user: name="dummy-api" shell="/bin/bash"

    - name: "ensure init script is in place"
      copy: src="../etc/dummy-api.init" dest="/etc/init.d/dummy-api" mode=555

    - name: "ensure nginx configuration file is in place"
      copy: src="../etc/nginx.conf" dest="/srv/dummy-api/conf/nginx.conf" mode=444

    - name: "ensure logrotate configuration file is in place"
      copy: src="../etc/dummy-api.logrotate" dest="/etc/logrotate.d/dummy-api" mode=444

    - name: "ensure app files are in place"
      copy: src="../{{ item }}" dest="/srv/dummy-api/{{ item }}" mode=444
      with_items:
        - "dummy-api.lua"
        - "random.lua"

    # wget http://openresty.org/download/ngx_openresty-1.7.10.1.tar.gz
    # tar -xvzf ngx_openresty-1.7.10.1.tar.gz
    # ./configure --with-pcre-jit --with-luajit --error-log-path=/var/log/dummy-api/error.log --http-log-path=/var/log/dummy-api/access.log --prefix=/srv/dummy-api/openresty/

    - name: "ensure dummy-api service is running"
      service: name="dummy-api" state=running enabled=yes

